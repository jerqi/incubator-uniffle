syntax = "proto3";
import "google/protobuf/empty.proto";
option java_package = "com.tencent.rss.proto";
option java_outer_classname = "RssProtos";
option java_generate_equals_and_hash = true;
package rss.common;

service ShuffleServer {
  rpc registerShuffle (ShuffleRegisterRequest) returns (ShuffleRegisterResponse) {}
  rpc sendShuffleData (SendShuffleDataRequest) returns (SendShuffleDataResponse) {}
  rpc commitShuffleTask (ShuffleCommitRequest) returns (ShuffleCommitResponse) {}
}

message ShuffleRegisterRequest {
  string appId = 1;
  int32 shuffleId = 2;
  int32 start = 3; // start partition
  int32 end = 4; // end partition
}

message ShuffleRegisterResponse {
  StatusCode status = 1;
  string retMsg = 2;
}

message SendShuffleDataRequest {
  string appId = 1;
  int32 shuffleId = 2;
  repeated ShuffleData shuffleData = 3;
}

message SendShuffleDataResponse {
  StatusCode status = 1;
  string retMsg = 2;
}

message ShuffleData {
  int32 partitionId = 1;
  repeated ShuffleBlock block = 2;
}

message ShuffleBlock {
  int64 blockId = 1;
  int32 length = 2;
  int64 crc = 3;
  bytes data = 4;
}

message ShuffleCommitRequest {
  string appId = 1;
  int32 shuffleId = 2;
}

message ShuffleCommitResponse {
  StatusCode status = 1;
  string retMsg = 2;
}

message ShuffleServerHeartBeatRequest {
  ShuffleServerId serverId = 1;
  int32 bufferUsedPercent = 2;
}

message ShuffleServerHeartBeatResponse {
  StatusCode status = 1;
  string retMsg = 2;
}

message ShuffleServerId {
  string id = 1;
  string ip = 2;
  int32 port = 3;
}

message ShuffleServerResult {
  StatusCode status = 1;
  string retMsg = 2;
}

/** Status code to identify the status of response */
enum StatusCode {
  SUCCESS = 0;
  DOUBLE_REGISTER = 1;
  NO_BUFFER = 2;
  INVALID_STORAGE = 3;
  NO_REGISTER = 4;
  NO_PARTITION = 5;
  INTERNAL_ERROR = 6;
  TIMEOUT = 7;
  // add more status
}



service CoordinatorServer {
  // Get Shuffle Server list
  rpc getShuffleServerList(google.protobuf.Empty) returns (GetShuffleServerListResponse);

  // Count Shuffle Server number
  rpc getShuffleServerNum(google.protobuf.Empty) returns (GetShuffleServerNumResponse);

  // Ask for suitable Shuffle Servers with partitions
  rpc getShuffleAssignments(GetShuffleServerRequest) returns (GetShuffleAssignmentsResponse);

  // Heartbeat between Shuffle Server and Coordinator Server
  rpc heartbeat(ShuffleServerHeartBeatRequest) returns (ShuffleServerHeartBeatResponse);

  // Get the global configuration of this Rss-cluster, i.e., data storage info
  rpc getShuffleDataStorageInfo(google.protobuf.Empty) returns (GetShuffleDataStorageInfoResponse);
  rpc checkServiceAvailable(google.protobuf.Empty) returns (CheckServiceAvailableResponse);

  // Report a client operation's result to coordinator server
  rpc reportClientOperation(ReportShuffleClientOpRequest) returns (ReportShuffleClientOpResponse);
}

message GetShuffleServerListResponse {
  repeated ShuffleServerId servers = 1;
}

message GetShuffleServerNumResponse {
  int32 num = 1;
}

message GetShuffleServerRequest {
  string clientHost = 1;
  string clientPort = 2;
  string clientProperty = 3;
  string applicationId = 4;
  int32 shuffleId = 5;
  int32 partitionNum = 6;
  int32 partitionPerServer = 7;
}

message PartitionRangeAssignment {
  int32 startPartition = 1;
  int32 endPartition = 2;
  // replica
  repeated ShuffleServerId server = 3;
}

message GetShuffleAssignmentsResponse {
  StatusCode status = 1;
  repeated PartitionRangeAssignment assignments = 2;
}

message ReportShuffleClientOpRequest {
  string clientHost = 1;
  int32 clientPort = 2;
  ShuffleServerId server = 3;
  string operation = 4;
}

message ReportShuffleClientOpResponse {
  StatusCode status = 1;
  string retMsg = 2;
}

message GetShuffleDataStorageInfoResponse {
  string storage = 1;
  string storagePath = 2;
  string storagePattern = 3;
}

message CheckServiceAvailableResponse {
  StatusCode status = 1;
  bool available = 2;
}

